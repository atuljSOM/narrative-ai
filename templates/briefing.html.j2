<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ brand }} — Weekly Growth Briefing</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif; 
      margin: 0;
      padding: 24px;
      color: #111;
      background: #fafafa;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 40px;
      text-align: center;
    }
    h1 { font-size: 32px; margin: 0 0 8px 0; font-weight: 700; }
    h2 { font-size: 20px; margin-top: 32px; margin-bottom: 16px; font-weight: 600; }
    h3 { font-size: 16px; margin-top: 12px; }
    .header-meta { opacity: 0.95; font-size: 15px; }
    .content { padding: 32px 40px; }
    
    .muted { color: #555; }
    .small { font-size: 12px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-left: 6px; background: #f2f2f2; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* Enhanced KPI Cards */
    .kpi { 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 16px;
      background: #fafafa;
      position: relative;
    }
    .kpi-badge {
      position: absolute;
      top: 6px;
      right: 8px;
      background: #6366f1;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
      z-index: 2;
    }
    /* Leave a little headroom so the badge does not sit in the header row */
    .kpi .row.header { margin-top: 18px; }
    .row { 
      display: grid; 
      grid-template-columns: 1.3fr 1fr 1.1fr 1fr; 
      gap: 8px; 
      padding: 8px 8px; 
      border-bottom: 1px solid #f0f0f0; 
      align-items: center;
    }
    .row.header { 
      font-weight: 600; 
      border-bottom: none;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
    }
    .row > div:nth-child(1) { text-align: left; }
    .row > div:nth-child(2) { text-align: right; padding-right: 10px; }
    .row > div:nth-child(3) { text-align: left; padding-left: 10px; }
    .row > div:nth-child(4) { text-align: left; }
    .seasonality-tag { display: inline-block; margin-left: 6px; font-size: 11px; color: #9ca3af; white-space: nowrap; }
    .row:last-child { border-bottom: none; }
    .green { color: #059669; font-weight: 600; } 
    .red { color: #dc2626; font-weight: 600; } 
    .gray { color: #9ca3af; }
    
    /* Validation Panel - Enhanced */
    .validation-banner {
      background: linear-gradient(to right, #f9fafb, #f3f4f6);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    
    .validation-banner.success {
      background: linear-gradient(to right, #f0fdf4, #dcfce7);
      border-color: #86efac;
    }
    
    .validation-banner.warning {
      background: linear-gradient(to right, #fffbeb, #fef3c7);
      border-color: #fde68a;
    }
    
    .validation-banner.error {
      background: linear-gradient(to right, #fef2f2, #fee2e2);
      border-color: #fecaca;
    }
    
    .validation-score-wrapper {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .validation-score-circle {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      position: relative;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .score-green { 
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }
    .score-amber { 
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
    }
    .score-red { 
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
    }
    
    .validation-summary {
      flex: 1;
      padding: 0 20px;
    }
    
    .validation-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .validation-message {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.5;
    }
    
    .validation-details {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .validation-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
      white-space: nowrap;
    }
    
    .check-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .check-green { background: #d1fae5; color: #065f46; }
    .check-amber { background: #fed7aa; color: #92400e; }
    .check-red { background: #fee2e2; color: #991b1b; }
    
    .validation-toggle {
      color: #6366f1;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
      font-weight: 500;
    }
    
    .validation-toggle:hover {
      text-decoration: underline;
    }
    
    .validation-details-grid {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    
    .validation-details-grid.show {
      display: grid;
    }
    
    /* Enhanced Charts Section */
    .charts-container {
      margin: 24px 0;
    }
    
    .charts-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    }
    
    .chart-card { 
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      background: #fafafa;
      transition: all 0.2s;
    }
    
    .chart-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 12px;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    img.chart { 
      width: 100%; 
      height: auto; 
      min-height: 320px;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      display: block;
      background: white;
      padding: 8px;
    }
    
    /* Actions */
    .section { margin-top: 32px; }
    .action-checklist { 
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    .action-checklist li { 
      margin: 8px 0;
      padding-left: 24px;
      position: relative;
    }
    .action-checklist li:before {
      content: "☐";
      position: absolute;
      left: 0;
      top: 0;
      color: #6366f1;
      font-weight: bold;
    }
    
    .action-card { 
      border: 2px solid #e5e7eb;
      border-left: 5px solid #6366f1;
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      transition: all 0.2s;
    }
    
    .action-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateX(4px);
    }
    
    .actions-header { 
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .num { 
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    
    .action-title { 
      font-size: 18px;
      font-weight: 600;
      flex: 1;
    }
    
    .badges { 
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .badge { 
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 12px;
      background: #eef2ff;
      color: #4f46e5;
      font-weight: 600;
    }
    
    .impact { background: #d1fae5; color: #065f46; }
    .effort { background: #fed7aa; color: #92400e; }
    
    .cta-row { 
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .btn { 
      display: inline-block;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 16px;
      text-decoration: none;
      color: #374151;
      background: white;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .btn:hover { 
      background: #6366f1;
      color: white;
      border-color: #6366f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
    }
    
    .steps ul { 
      margin: 8px 0 8px 20px;
      padding-left: 0;
    }
    
    .steps li {
      margin: 6px 0;
      font-size: 14px;
      color: #4b5563;
    }
    
    .prev { color: #9ca3af; font-size: 11px; }
    
    /* Watchlist */
    .watchlist-card {
      border: 1px solid #e5e7eb;
      border-left: 5px solid #9ca3af;
      background: #fafafa;
      opacity: 0.85;
    }
    
    /* Footer */
    .footer {
      background: #f9fafb;
      padding: 24px 40px;
      text-align: center;
      border-top: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .validation-details { display: none; }
      .content { padding: 20px; }
    }
  </style>
</head>
<body>

{% macro fmt_money(x, decimals=0) -%}
  {%- if x is not none -%}
    {%- if x >= 1000000 -%}${{ '%.1fM' % (x / 1000000) }}
    {%- elif x >= 1000 -%}${{ '%.1fK' % (x / 1000) }}
    {%- else -%}${{ ('%.{}f'.format(decimals)) % x }}{%- endif -%}
  {%- else -%}—{%- endif -%}
{%- endmacro %}

{% macro fmt_pct(x, digits=1) -%}
  {{ ('%.{}f%%'.format(digits)) % (x*100) if x is not none else '—' }}
{%- endmacro %}

{% macro fmt_delta_pct(x, digits=1) -%}
  {{ ('%+.' ~ digits ~ 'f%%') % (x*100) if x is not none else '—' }}
{%- endmacro %}

{% macro arrow(delta, good_when_up=True, significant=True) -%}
  {%- set dir = 'up' if (delta is not none and delta >= 0) else 'down' -%}
  {%- set good = (delta is not none) and ((delta >= 0 and good_when_up) or (delta < 0 and not good_when_up)) -%}
  {%- set color = 'green' if (significant and good) else ('red' if (significant and not good) else 'gray') -%}
  <span class="{{ color }}">{{ '▲' if dir == 'up' else '▼' }}</span>
{%- endmacro %}

{% macro kpi_block(label) -%}
  <div class="kpi">
    {% if aligned.get('meta', {}).get('seasonal_adjusted') %}
      <span class="kpi-badge">Adjusted for seasonality</span>
    {% endif %}
    <div class="row header">
      <div>Metric</div><div>Current</div><div>Change</div><div>Notes</div>
    </div>

    {# Net Sales #}
    {% set curr = aligned[label]['net_sales'] %}
    {% set dlt = aligned[label]['delta']['net_sales'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Net Sales</strong></div>
      <div>{{ fmt_money(curr) }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev) }})</span>
      </div>
      <div class="small muted">—</div>
    </div>

    {# Orders #}
    {% set curr = aligned[label]['orders'] %}
    {% set dlt = aligned[label]['delta']['orders'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Orders</strong></div>
      <div>{{ curr if curr is not none else '—' }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ prev|int if prev is not none else '—' }})</span>
      </div>
      <div class="small muted">—</div>
    </div>

    {# AOV #}
    {% set curr = aligned[label]['aov'] %}
    {% set dlt = aligned[label]['delta']['aov'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>AOV</strong></div>
      <div>{{ fmt_money(curr, 0) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['aov']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev, 0) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['aov'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}—{% endif %}
      </div>
    </div>

    {# Discount Rate #}
    {% set curr = aligned[label]['discount_rate'] %}
    {% set dlt = aligned[label]['delta']['discount_rate'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Discount Rate</strong></div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, False, aligned[label]['sig']['discount_rate']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['discount_rate'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}—{% endif %}
      </div>
    </div>

    {# Repeat Share #}
    {% set curr = aligned[label]['repeat_share'] %}
    {% set dlt = aligned[label]['delta']['repeat_share'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Repeat Share</strong></div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['repeat_share']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['repeat_share'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}—{% endif %}
      </div>
    </div>
  </div>
{%- endmacro %}

<div class="container">
  <header class="header">
    <h1>{{ brand }}</h1>
    <div class="header-meta">Weekly Growth Briefing • {{ aligned['anchor'].strftime('%B %d, %Y') if aligned.get('anchor') else 'Current Week' }}</div>
  </header>

  <div class="content">
    <!-- Enhanced Data Validation Panel -->
    {% if outputs.validation_results %}
    {% set score = outputs.validation_results.validation_score %}
    {% set status = outputs.validation_results.overall_status %}
    <div class="validation-banner {% if status == 'green' %}success{% elif status == 'amber' %}warning{% else %}error{% endif %}">
      <div class="validation-score-wrapper">
        <div class="validation-score-circle {% if score >= 80 %}score-green{% elif score >= 60 %}score-amber{% else %}score-red{% endif %}">
          {{ score }}
        </div>
        <div class="validation-summary">
          <div class="validation-title">Data Quality Score</div>
          <div class="validation-message">{{ outputs.validation_results.summary }}</div>
        </div>
      </div>
      
      <div class="validation-details">
        {% for check_name, check_result in outputs.validation_results.checks.items() %}
        <div class="validation-check">
          <div class="check-icon {% if check_result.status == 'green' %}check-green{% elif check_result.status == 'amber' %}check-amber{% else %}check-red{% endif %}">
            {% if check_result.status == 'green' %}✓{% elif check_result.status == 'amber' %}!{% else %}✗{% endif %}
          </div>
          <span>{{ check_name.replace('_', ' ').title() }}</span>
        </div>
        {% endfor %}
      </div>
    </div>

    {% if status != 'green' %}
    <a href="#" class="validation-toggle" onclick="toggleValidation(event)">
      <span>View validation details</span>
      <span>▼</span>
    </a>
    <div class="validation-details-grid" id="validationDetails">
      {% for check_name, check_result in outputs.validation_results.checks.items() %}
        {% if check_result.status != 'green' %}
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
          <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; margin-bottom: 4px;">{{ check_name }}</div>
          <div style="font-size: 13px; color: #374151;">{{ check_result.message }}</div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    {% endif %}

    <!-- KPI Section with L7 and L28 -->
    <section class="section">
      <h2>Key Performance Indicators</h2>
      <div class="grid">
        <div>
          <h3>Last 7 Days</h3>
          {{ kpi_block('L7') }}
        </div>
        <div>
          <h3>Last 28 Days</h3>
          {{ kpi_block('L28') }}
        </div>
      </div>
    </section>

    <!-- Enhanced Charts Section -->
    {% if outputs.get('charts') and outputs['charts'] %}
    <section class="section charts-container">
      <h2>Analytics & Insights</h2>
      <div class="charts-grid">
        {% for chart in outputs['charts'] %}
        <div class="chart-card">
          <div class="chart-title">
            {% if 'repurchase' in chart.lower() %}Customer Repurchase Timeline
            {% elif 'velocity' in chart.lower() %}Product Performance
            {% elif 'segment' in chart.lower() %}Customer Segments
            {% elif 'impact' in chart.lower() or 'forecast' in chart.lower() %}Revenue Impact
            {% else %}Analysis{% endif %}
          </div>
          <img class="chart" src="{{ chart }}" alt="Chart" />
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Actions Section -->
    <section class="section">
      <h2>Your Top Actions <span class="pill">This Week's Focus</span></h2>

      {% if outputs.get('actions') and outputs['actions'] %}
        <ul class="action-checklist">
          {% for a in outputs['actions'] %}
            <li>
              <strong>{{ a.get('title','') }}</strong> — {{ a.get('do_this','') }}
              {% if a.get('offer') %}
                <span class="small muted">({{ a['offer'].get('type') }}{% if a['offer'].get('value') %}: {{ a['offer']['value'] }}%{% endif %})</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>

        {% for a in outputs['actions'] %}
          <div class="action-card">
            <div class="actions-header">
              <div class="num">{{ loop.index }}</div>
              <div class="action-title">{{ a.get('title','') }}</div>
              <div class="badges">
                {% if a.get('expected_$') %}<span class="badge impact">+{{ fmt_money(a.get('expected_$')) }}</span>{% endif %}
                {% if a.get('effort') %}<span class="badge effort">Effort: {{ a.get('effort') }}/5</span>{% endif %}
                {% if a.get('confidence_label') %}<span class="badge">{{ a.get('confidence_label') }}</span>{% endif %}
              </div>
            </div>
            <div class="muted" style="margin-bottom: 12px;">{{ a.get('do_this','') }}</div>
            {% if a.get('how_to_launch') %}
              <div class="steps">
                <div class="small" style="margin-top:8px;"><strong>Implementation Steps:</strong></div>
                <ul>
                  {% for step in a['how_to_launch'][:3] %}<li>{{ step }}</li>{% endfor %}
                </ul>
              </div>
            {% endif %}
            <div class="cta-row">
              {% if a.get('attachment') %}<span class="btn">📥 Download Segment</span>{% endif %}
              {% if a.get('targeting') %}<span class="btn">🎯 View Targeting</span>{% endif %}
              {% if a.get('offer') %}<span class="btn">🏷 {{ a['offer'].get('type', 'Offer') }}</span>{% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="text-align: center; padding: 20px;">No actions passed all confidence thresholds. See pilot recommendations below.</div>
      {% endif %}
    </section>

    <!-- Pilot Actions -->
    {% if outputs.get('pilot_actions') and outputs['pilot_actions'] %}
    <section class="section">
      <h2>Pilot Test <span class="pill" style="background: #fef3c7; color: #92400e;">Experimental</span></h2>
      {% for p in outputs['pilot_actions'] %}
        <div class="action-card" style="border-left-color:#f59e0b;">
          <div class="actions-header">
            <div class="num" style="background: linear-gradient(135deg, #f59e0b, #d97706);">P</div>
            <div class="action-title">{{ p.get('title','') }}</div>
            <div class="badges">
              <span class="badge" style="background: #fed7aa; color: #92400e;">Pilot</span>
              {% if p.get('expected_$') %}<span class="badge impact">Est. +{{ fmt_money(p.get('expected_$')) }}</span>{% endif %}
            </div>
          </div>
          <div class="muted">{{ p.get('do_this','') }}</div>
          <div class="small" style="margin-top:12px; padding: 8px; background: #fffbeb; border-radius: 6px;">
            <strong>Test Parameters:</strong> {{ (p.get('pilot_audience_fraction',0.2)*100)|int }}% of audience • 
            Budget: {{ fmt_money(p.get('pilot_budget_cap', 200)) }} • 
            Duration: 14 days • 
            Success: {{ p.get('decision_rule','CI excludes 0') }}
          </div>
        </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- Watchlist -->
    {% if outputs.get('watchlist') and outputs['watchlist'] %}
    <section class="section">
      <h2>Watchlist <span class="pill" style="background: #f3f4f6;">Monitoring</span></h2>
      {% for w in outputs['watchlist'] %}
        <div class="action-card watchlist-card">
          <div class="action-title">{{ w.get('title','') }}</div>
          <div class="small muted" style="margin-top:8px;">
            {% if w.get('reasons') %}
              {{ w['reasons'] | join(' • ') }}
            {% else %}
              Needs: {{ (w.get('failed', []) or ['more data']) | join(', ') }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- Evidence Section -->
    <section class="section">
      <h2>Statistical Evidence</h2>
      <div style="background: #f9fafb; border-radius: 12px; padding: 20px;">
        <p class="muted" style="margin-bottom: 16px;">Why we believe this week's actions will drive results:</p>
        <ul style="margin-left: 20px;">
          {% if outputs.receipts and outputs.receipts|length > 0 %}
            {% for r in outputs.receipts %}
              <li style="margin: 8px 0; color: #374151;">{{ r }}</li>
            {% endfor %}
          {% else %}
            <li>Actions selected based on L28 performance deltas with statistical significance (p < 0.05)</li>
            <li>Expected impact calculated using your store's historical conversion rates and gross margin</li>
            <li>Confidence levels determined through Benjamini-Hochberg adjusted testing to minimize false positives</li>
          {% endif %}
        </ul>
      </div>
    </section>

    <!-- Attachments -->
    {% if outputs.get('segments_bundle') %}
    <section class="section">
      <h2>Attachments</h2>
      <div style="background: #f9fafb; border-radius: 8px; padding: 16px;">
        <strong>Segments Bundle:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px;">{{ outputs['segments_bundle'] }}</code>
        <div class="small muted" style="margin-top: 8px;">Ready for Klaviyo import - contains all customer segments for this week's actions</div>
      </div>
    </section>
    {% endif %}
  </div>

  <footer class="footer">
    <strong style="color: #6366f1;">Aura Intelligence</strong><br>
    Prescriptive Analytics for Beauty & Wellness Brands<br>
    <div style="margin-top: 8px; font-size: 12px;">
      Generated {{ aligned['anchor'].strftime('%B %d, %Y at %I:%M %p') if aligned.get('anchor') else 'today' }} • 
      Analysis window: L28 • 
      Confidence threshold: 90%
    </div>
  </footer>
</div>

<script>
function toggleValidation(event) {
  event.preventDefault();
  const details = document.getElementById('validationDetails');
  const toggle = event.currentTarget;
  const isShowing = details.classList.contains('show');
  
  details.classList.toggle('show');
  toggle.querySelector('span:last-child').textContent = isShowing ? '▼' : '▲';
  toggle.querySelector('span:first-child').textContent = isShowing ? 'View validation details' : 'Hide validation details';
}
</script>

</body>
</html>
