<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ brand }} ‚Äî Monthly Growth Briefing</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif; 
      margin: 0;
      padding: 24px;
      color: #111;
      background: #fafafa;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 40px;
      text-align: center;
    }
    h1 { font-size: 32px; margin: 0 0 8px 0; font-weight: 700; }
    h2 { font-size: 20px; margin-top: 32px; margin-bottom: 16px; font-weight: 600; }
    h3 { font-size: 16px; margin-top: 12px; }
    .header-meta { opacity: 0.95; font-size: 15px; }
    .content { padding: 32px 40px; }
    
    .muted { color: #555; }
    .small { font-size: 12px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-left: 6px; background: #f2f2f2; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* KPI Cards */
    .kpi { 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 16px;
      background: #fafafa;
      position: relative;
    }
    .kpi-badge {
      position: absolute;
      top: 6px;
      right: 8px;
      background: #6366f1;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
      z-index: 2;
    }
    .kpi .row.header { margin-top: 18px; }
    .row { 
      display: grid; 
      grid-template-columns: 1.3fr 1fr 1.1fr 1fr; 
      gap: 8px; 
      padding: 8px 8px; 
      border-bottom: 1px solid #f0f0f0; 
      align-items: center;
    }
    .row.header { 
      font-weight: 600; 
      border-bottom: none;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
    }
    .row > div:nth-child(1) { text-align: left; }
    .row > div:nth-child(2) { text-align: right; padding-right: 10px; }
    .row > div:nth-child(3) { text-align: left; padding-left: 10px; }
    .row > div:nth-child(4) { text-align: left; }
    .row:last-child { border-bottom: none; }
    .green { color: #059669; font-weight: 600; } 
    .red { color: #dc2626; font-weight: 600; } 
    .gray { color: #9ca3af; }
    
    /* Performance Tracking Panel */
    .performance-panel {
      background: linear-gradient(to right, #f0f9ff, #e0f2fe);
      border: 1px solid #7dd3fc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .performance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .performance-title {
      font-size: 16px;
      font-weight: 600;
      color: #0c4a6e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .accuracy-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    
    .accuracy-excellent { background: #10b981; }
    .accuracy-good { background: #3b82f6; }
    .accuracy-fair { background: #f59e0b; }
    .accuracy-poor { background: #ef4444; }
    .accuracy-new { background: #8b5cf6; }
    
    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .performance-metric {
      background: white;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #1e293b;
    }
    
    .metric-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      margin-top: 4px;
    }
    
    /* Validation Panel */
    .validation-banner {
      background: linear-gradient(to right, #f9fafb, #f3f4f6);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    
    .validation-banner.success {
      background: linear-gradient(to right, #f0fdf4, #dcfce7);
      border-color: #86efac;
    }
    
    .validation-banner.warning {
      background: linear-gradient(to right, #fffbeb, #fef3c7);
      border-color: #fde68a;
    }
    
    .validation-banner.error {
      background: linear-gradient(to right, #fef2f2, #fee2e2);
      border-color: #fecaca;
    }
    
    .validation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .validation-score-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .validation-score-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: white;
      position: relative;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .score-green { background: linear-gradient(135deg, #10b981, #059669); }
    .score-amber { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .score-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
    
    .data-grade {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 18px;
      color: white;
      margin-left: 8px;
    }
    
    .grade-a { background: #10b981; }
    .grade-b-plus { background: #34d399; }
    .grade-b { background: #fbbf24; }
    .grade-c { background: #f59e0b; }
    .grade-d { background: #ef4444; }
    
    .validation-issues {
      display: grid;
      gap: 8px;
      margin-top: 12px;
    }
    
    .validation-issue {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .issue-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .issue-critical { background: #fee2e2; color: #991b1b; }
    .issue-warning { background: #fed7aa; color: #92400e; }
    .issue-info { background: #dbeafe; color: #1e40af; }
    
    .validation-recommendations {
      margin-top: 16px;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fde68a;
      border-radius: 8px;
    }
    
    .validation-recommendations h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #92400e;
    }
    
    .validation-recommendations ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .validation-recommendations li {
      margin: 4px 0;
      font-size: 12px;
      color: #78350f;
    }
    
    /* Pending Actions Tracker */
    .pending-actions {
      background: #fafafa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
    }
    
    .pending-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .pending-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    
    .pending-count {
      background: #6366f1;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .pending-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .pending-item:last-child {
      border-bottom: none;
    }
    
    .pending-info {
      flex: 1;
    }
    
    .pending-action {
      font-size: 13px;
      color: #1f2937;
      font-weight: 500;
    }
    
    .pending-meta {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .pending-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-pending { background: #f3f4f6; color: #6b7280; }
    .status-in-progress { background: #dbeafe; color: #1e40af; }
    .status-overdue { background: #fee2e2; color: #991b1b; }
    
    .track-button {
      padding: 4px 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 12px;
      color: #4b5563;
      cursor: pointer;
      text-decoration: none;
    }
    
    .track-button:hover {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }
    
    /* Charts Section */
    .charts-container {
      margin: 24px 0;
    }
    
    .charts-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    }
    
    .chart-card { 
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      background: #fafafa;
      transition: all 0.2s;
    }
    
    .chart-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 12px;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    img.chart { 
      width: 100%; 
      height: auto; 
      min-height: 320px;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      display: block;
      background: white;
      padding: 8px;
    }
    
    /* Actions */
    .section { margin-top: 32px; }
    .action-checklist { 
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    .action-checklist li { 
      margin: 8px 0;
      padding-left: 24px;
      position: relative;
    }
    .action-checklist li:before {
      content: "‚òê";
      position: absolute;
      left: 0;
      top: 0;
      color: #6366f1;
      font-weight: bold;
    }
    
    .action-card { 
      border: 2px solid #e5e7eb;
      border-left: 5px solid #6366f1;
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      transition: all 0.2s;
      position: relative;
    }
    
    .action-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateX(4px);
    }
    
    .action-id {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 10px;
      color: #9ca3af;
      font-family: monospace;
    }
    
    .actions-header { 
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .num { 
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    
    .action-title { 
      font-size: 18px;
      font-weight: 600;
      flex: 1;
    }
    
    .badges { 
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .badge { 
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 12px;
      background: #eef2ff;
      color: #4f46e5;
      font-weight: 600;
    }
    
    .impact { background: #d1fae5; color: #065f46; }
    .effort { background: #fed7aa; color: #92400e; }
    
    .cta-row { 
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .btn { 
      display: inline-block;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 16px;
      text-decoration: none;
      color: #374151;
      background: white;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .btn:hover { 
      background: #6366f1;
      color: white;
      border-color: #6366f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
    }
    
    .btn-track {
      background: #fbbf24;
      border-color: #f59e0b;
      color: #78350f;
    }
    
    .btn-track:hover {
      background: #f59e0b;
      color: white;
    }
    
    .steps ul { 
      margin: 8px 0 8px 20px;
      padding-left: 0;
    }
    
    .steps li {
      margin: 6px 0;
      font-size: 14px;
      color: #4b5563;
    }
    
    .prev { color: #9ca3af; font-size: 11px; }
    
    /* Watchlist */
    .watchlist-card {
      border: 1px solid #e5e7eb;
      border-left: 5px solid #9ca3af;
      background: #fafafa;
      opacity: 0.85;
    }
    
    /* Footer */
    .footer {
      background: #f9fafb;
      padding: 24px 40px;
      text-align: center;
      border-top: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .content { padding: 20px; }
      .performance-metrics { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

{% macro fmt_money(x, decimals=0) -%}
  {%- if x is not none -%}
    {%- if x >= 1000000 -%}${{ '%.1fM' % (x / 1000000) }}
    {%- elif x >= 1000 -%}${{ '%.1fK' % (x / 1000) }}
    {%- else -%}${{ ('%.{}f'.format(decimals)) % x }}{%- endif -%}
  {%- else -%}‚Äî{%- endif -%}
{%- endmacro %}

{% macro fmt_pct(x, digits=1) -%}
  {{ ('%.{}f%%'.format(digits)) % (x*100) if x is not none else '‚Äî' }}
{%- endmacro %}

{% macro fmt_delta_pct(x, digits=1) -%}
  {{ ('%+.' ~ digits ~ 'f%%') % (x*100) if x is not none else '‚Äî' }}
{%- endmacro %}

{% macro arrow(delta, good_when_up=True, significant=True) -%}
  {%- set dir = 'up' if (delta is not none and delta >= 0) else 'down' -%}
  {%- set good = (delta is not none) and ((delta >= 0 and good_when_up) or (delta < 0 and not good_when_up)) -%}
  {%- set color = 'green' if (significant and good) else ('red' if (significant and not good) else 'gray') -%}
  <span class="{{ color }}">{{ '‚ñ≤' if dir == 'up' else '‚ñº' }}</span>
{%- endmacro %}

{% macro kpi_block(label) -%}
  <div class="kpi">
    <div class="row header">
      <div>Metric</div><div>Current</div><div>Change</div><div>Notes</div>
    </div>

    {# Net Sales #}
    {% set curr = aligned[label]['net_sales'] %}
    {% set dlt = aligned[label]['delta']['net_sales'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Net Sales</strong></div>
      <div>{{ fmt_money(curr) }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev) }})</span>
      </div>
      <div class="small muted">
        {% set se = aligned[label].get('seasonal_expected', {}) %}
        {% set nss = se.get('net_sales_surprise') %}
        {% if nss is not none %}
          vs seasonal {{ fmt_delta_pct(nss) }}
        {% else %}‚Äî{% endif %}
      </div>
    </div>

    {# Orders #}
    {% set curr = aligned[label]['orders'] %}
    {% set dlt = aligned[label]['delta']['orders'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Orders</strong></div>
      <div>{{ curr if curr is not none else '‚Äî' }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ prev|int if prev is not none else '‚Äî' }})</span>
      </div>
      <div class="small muted">
        {% set se = aligned[label].get('seasonal_expected', {}) %}
        {% set osur = se.get('orders_surprise') %}
        {% if osur is not none %}
          vs seasonal {{ fmt_delta_pct(osur) }}
        {% else %}‚Äî{% endif %}
      </div>
    </div>

    {# AOV #}
    {% set curr = aligned[label]['aov'] %}
    {% set dlt = aligned[label]['delta']['aov'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>AOV</strong></div>
      <div>{{ fmt_money(curr, 0) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['aov']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev, 0) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['aov'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}‚Äî{% endif %}
      </div>
    </div>

    {# Discount Rate #}
    {% set curr = aligned[label]['discount_rate'] %}
    {% set dlt = aligned[label]['delta']['discount_rate'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Discount Rate</strong></div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, False, aligned[label]['sig']['discount_rate']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['discount_rate'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}‚Äî{% endif %}
      </div>
    </div>

    {# Repeat Share #}
    {% set curr = aligned[label]['repeat_share'] %}
    {% set dlt = aligned[label]['delta']['repeat_share'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div><strong>Repeat Share</strong></div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['repeat_share']) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% set p = aligned[label]['p']['repeat_share'] %}
        {% if p is not none %}p={{ '%.3f' % p }}{% else %}‚Äî{% endif %}
      </div>
    </div>
  </div>
{%- endmacro %}

<div class="container">
  <header class="header">
    <h1>{{ brand }}</h1>
    <div class="header-meta">Monthly Growth Briefing ‚Ä¢ {{ aligned['anchor'].strftime('%B %Y') if aligned.get('anchor') else 'Current Month' }}</div>
  </header>

  <div class="content">
    <!-- Performance Tracking Panel -->
    {% if outputs.performance_summary %}
    <div class="performance-panel">
      <div class="performance-header">
        <div class="performance-title">
          üìä Prediction Performance
          {% if outputs.performance_summary.n_completed > 0 %}
            {% set acc = outputs.performance_summary.aggregate_accuracy_pct %}
            {% if acc >= 90 and acc <= 110 %}
              <span class="accuracy-badge accuracy-excellent">{{ acc }}% Accurate</span>
            {% elif acc >= 75 and acc <= 125 %}
              <span class="accuracy-badge accuracy-good">{{ acc }}% Accurate</span>
            {% elif acc >= 50 and acc <= 150 %}
              <span class="accuracy-badge accuracy-fair">{{ acc }}% Accurate</span>
            {% else %}
              <span class="accuracy-badge accuracy-poor">{{ acc }}% Accurate</span>
            {% endif %}
          {% else %}
            <span class="accuracy-badge accuracy-new">New Customer</span>
          {% endif %}
        </div>
      </div>
      
      {% if outputs.performance_summary.n_completed > 0 %}
      <div class="performance-metrics">
        <div class="performance-metric">
          <div class="metric-value">{{ outputs.performance_summary.n_completed }}</div>
          <div class="metric-label">Actions Tracked</div>
        </div>
        <div class="performance-metric">
          <div class="metric-value">{{ fmt_money(outputs.performance_summary.total_actual_revenue) }}</div>
          <div class="metric-label">Actual Revenue</div>
        </div>
        <div class="performance-metric">
          <div class="metric-value">{{ outputs.performance_summary.actions_on_target }}</div>
          <div class="metric-label">On Target</div>
        </div>
        <div class="performance-metric">
          <div class="metric-value">{{ outputs.performance_summary.median_accuracy_pct }}%</div>
          <div class="metric-label">Median Accuracy</div>
        </div>
      </div>
      {% else %}
      <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px;">
        Track your first action to see prediction accuracy metrics here.
      </p>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Data Validation Panel -->
    {% if outputs.validation_results %}
    {% set score = outputs.validation_results.validation_score %}
    {% set status = outputs.validation_results.overall_status %}
    {% set grade = outputs.validation_results.data_quality_grade %}
    
    {% if status == 'green' %}
      {% set banner_class = 'success' %}
    {% elif status == 'amber' %}
      {% set banner_class = 'warning' %}
    {% else %}
      {% set banner_class = 'error' %}
    {% endif %}
    
    <div class="validation-banner {{ banner_class }}">
      <div class="validation-header">
        <div class="validation-score-section">
          {% if score >= 80 %}
            {% set score_class = 'score-green' %}
          {% elif score >= 60 %}
            {% set score_class = 'score-amber' %}
          {% else %}
            {% set score_class = 'score-red' %}
          {% endif %}
          
          <div class="validation-score-circle {{ score_class }}">
            {{ score }}
          </div>
          <div>
            <div style="font-size: 16px; font-weight: 600; color: #1f2937;">
              Data Quality Score
              {% if grade == 'A' %}
                <span class="data-grade grade-a">{{ grade }}</span>
              {% elif grade == 'C' %}
                <span class="data-grade grade-c">{{ grade }}</span>
              {% else %}
                <span class="data-grade grade-d">{{ grade }}</span>
              {% endif %}
            </div>
            <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">
              {{ outputs.validation_results.summary }}
            </div>
          </div>
        </div>
      </div>
      
      {% if outputs.validation_results.critical_issues or outputs.validation_results.warnings %}
      <div class="validation-issues">
        {% for issue in outputs.validation_results.critical_issues[:3] %}
        <div class="validation-issue">
          <div class="issue-icon issue-critical">‚ùå</div>
          <span>{{ issue }}</span>
        </div>
        {% endfor %}
        {% for warning in outputs.validation_results.warnings[:2] %}
        <div class="validation-issue">
          <div class="issue-icon issue-warning">‚ö†Ô∏è</div>
          <span>{{ warning }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      
      {% if outputs.validation_results.recommendations %}
      <div class="validation-recommendations">
        <h4>Recommended Actions:</h4>
        <ul>
          {% for rec in outputs.validation_results.recommendations %}
          <li>{{ rec }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Pending Actions Tracker -->
    {% if outputs.pending_actions and outputs.pending_actions|length > 0 %}
    <div class="pending-actions">
      <div class="pending-header">
        <div class="pending-title">üìã Actions Awaiting Results</div>
        <div class="pending-count">{{ outputs.pending_actions|length }}</div>
      </div>
      {% for action in outputs.pending_actions[:5] %}
      <div class="pending-item">
        <div class="pending-info">
          <div class="pending-action">{{ action.play_id|replace('_', ' ')|title }}</div>
          <div class="pending-meta">
            Day {{ action.days_waiting }} ‚Ä¢ Expected: {{ fmt_money(action.predicted.revenue) }}
            {% if action.is_overdue %} ‚Ä¢ <span style="color: #ef4444;">Overdue for measurement</span>{% endif %}
          </div>
        </div>
        <div class="pending-status">
          {% if action.is_overdue %}
            <span class="status-badge status-overdue">Overdue</span>
          {% elif action.status == 'in_progress' %}
            <span class="status-badge status-in-progress">In Progress</span>
          {% else %}
            <span class="status-badge status-pending">Pending</span>
          {% endif %}
          <a href="#" class="track-button" onclick="alert('Track results for action: {{ action.action_id }}'); return false;">Track</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- KPI Section -->
    <section class="section">
      <h2>Key Performance Indicators</h2>
      {% set show_l7 = outputs.cfg.get('SHOW_L7', True) %}
      {% if show_l7 %}
      <div class="grid">
        <div>
          <h3>Last 7 Days</h3>
          {{ kpi_block('L7') }}
        </div>
        <div>
          <h3>Last 28 Days</h3>
          {{ kpi_block('L28') }}
        </div>
      </div>
      {% else %}
      <div class="grid" style="grid-template-columns: 1fr;">
        <div>
          <h3>Last 28 Days (vs prior 28 days)</h3>
          {{ kpi_block('L28') }}
        </div>
      </div>
      {% endif %}
    </section>

    <!-- Charts Section -->
    {% if outputs.get('charts') and outputs['charts'] %}
    <section class="section charts-container">
      <h2>Analytics & Insights</h2>
      <div class="charts-grid">
        {% for chart in outputs['charts'] %}
        <div class="chart-card">
          <div class="chart-title">
            {% if 'repurchase' in chart.lower() %}Customer Repurchase Timeline
            {% elif 'velocity' in chart.lower() %}Product Performance
            {% elif 'segment' in chart.lower() %}Customer Segments
            {% elif 'impact' in chart.lower() or 'forecast' in chart.lower() %}Revenue Impact
            {% elif 'cohort' in chart.lower() or 'retention' in chart.lower() %}Cohort Retention
            {% elif 'first_to_second' in chart.lower() or 'second' in chart.lower() %}First-to-Second Purchase
            {% else %}Analysis{% endif %}
          </div>
          <img class="chart" src="{{ chart }}" alt="Chart" />
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Actions Section -->
    <section class="section">
      <h2>Your Top Actions <span class="pill">This Month's Focus</span></h2>

      {% if outputs.get('actions') and outputs['actions'] %}
        <ul class="action-checklist">
          {% for a in outputs['actions'] %}
            <li>
              <strong>{{ a.get('title','') }}</strong> ‚Äî {{ a.get('do_this','') }}
              {% if a.get('offer') %}
                <span class="small muted">({{ a['offer'].get('type') }}{% if a['offer'].get('value') %}: {{ a['offer']['value'] }}%{% endif %})</span>
              {% endif %}
              {% if a.get('action_id') %}
                <span class="small muted" style="font-family: monospace; margin-left: 8px;">[{{ a.action_id[:8] }}...]</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>

        {% for a in outputs['actions'] %}
          <div class="action-card">
            {% if a.get('action_id') %}
              <div class="action-id" title="{{ a.action_id }}">ID: {{ a.action_id[:12] }}...</div>
            {% endif %}
            <div class="actions-header">
              <div class="num">{{ loop.index }}</div>
              <div class="action-title">{{ a.get('title','') }}</div>
              <div class="badges">
                {% if a.get('expected_$') %}<span class="badge impact">+{{ fmt_money(a.get('expected_$')) }}</span>{% endif %}
                {% if a.get('effort') %}<span class="badge effort">Effort: {{ a.get('effort') }}/5</span>{% endif %}
                {% if a.get('confidence_label') %}<span class="badge">Confidence: {{ a.get('confidence_label') }}</span>{% endif %}
                {% if a.get('overlap_with_prior') %}
                  <span class="badge" style="background:#fee2e2; color:#991b1b;">Overlap: {{ (a.get('overlap_with_prior')*100)|round(1) }}%</span>
                {% endif %}
                {% if a.get('interaction_factor') and a.get('interaction_factor') < 1 %}
                  <span class="badge" title="{{ (a.get('interaction_notes') or []) | join(', ') }}" style="background:#ffe4e6; color:#9f1239;">Adj: -{{ ((1 - a.get('interaction_factor'))*100)|round(0) }}%</span>
                {% endif %}
              </div>
            </div>
            <div class="muted" style="margin-bottom: 12px;">{{ a.get('do_this','') }}</div>

            {# Stats summary for this action if available #}
            {% set p = a.get('p') %}
            {% set ci_lo = a.get('ci_low') %}
            {% set ci_hi = a.get('ci_high') %}
            {% if (p is not none) or (ci_lo is not none and ci_hi is not none) %}
              <div class="small" style="color:#374151; margin: 6px 0 8px 0;">
                <strong>Stats:</strong>
                {% if p is not none and p == p %}p={{ '%.3f' % p }}{% endif %}
                {% if ci_lo is not none and ci_hi is not none %}
                  {% if a.get('metric') in ['repeat_rate','discount_rate','subscription'] %}
                    ‚Ä¢ 95% CI Œî=[{{ fmt_pct(ci_lo,1) }}, {{ fmt_pct(ci_hi,1) }}]
                  {% else %}
                    ‚Ä¢ 95% CI Œî=[{{ '%.3f' % ci_lo }}, {{ '%.3f' % ci_hi }}]
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}
            
            {% if a.get('evidence') %}
              <div style="background: #f0f9ff; border-left: 3px solid #3b82f6; padding: 8px 12px; margin: 12px 0; border-radius: 4px;">
                <div class="small" style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">Why this will work:</div>
                <ul style="margin: 4px 0 0 16px; padding: 0;">
                  {% for e in a['evidence'][:2] %}
                  <li class="small" style="color: #475569;">{{ e }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            
            {% if a.get('how_to_launch') %}
              <div class="steps">
                <div class="small" style="margin-top:8px;"><strong>Implementation Steps:</strong></div>
                <ul>
                  {% for step in a['how_to_launch'][:3] %}<li>{{ step }}</li>{% endfor %}
                </ul>
              </div>
            {% endif %}
            <div class="cta-row">
              {% if a.get('attachment') %}<span class="btn">üì• Download Segment</span>{% endif %}
              {% if a.get('targeting') %}<span class="btn">üéØ View Targeting</span>{% endif %}
              {% if a.get('offer') %}<span class="btn">üè∑ {{ a['offer'].get('type', 'Offer') }}</span>{% endif %}
              {% if a.get('action_id') %}
                <span class="btn btn-track" onclick="alert('Mark as implemented: {{ a.action_id }}\\n\\nIn production, this would open a form to track implementation details.'); return false;">
                  ‚úì Mark Implemented
                </span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="text-align: center; padding: 20px;">No actions passed all confidence thresholds. See pilot recommendations below.</div>
      {% endif %}
    </section>

    <!-- Pilot Actions -->
    {% if outputs.get('pilot_actions') and outputs['pilot_actions'] %}
    <section class="section">
      <h2>Pilot Test <span class="pill" style="background: #fef3c7; color: #92400e;">Experimental</span></h2>
      {% for p in outputs['pilot_actions'] %}
        <div class="action-card" style="border-left-color:#f59e0b;">
          {% if p.get('action_id') %}
            <div class="action-id" title="{{ p.action_id }}">ID: {{ p.action_id[:12] }}...</div>
          {% endif %}
          <div class="actions-header">
            <div class="num" style="background: linear-gradient(135deg, #f59e0b, #d97706);">P</div>
            <div class="action-title">{{ p.get('title','') }}</div>
            <div class="badges">
              <span class="badge" style="background: #fed7aa; color: #92400e;">Pilot</span>
              {% if p.get('expected_$') %}
                <span class="badge impact">Est. +{{ fmt_money(p.get('expected_$')) }}</span>
              {% endif %}
            </div>
          </div>
          <div class="muted">{{ p.get('do_this','') }}</div>
          
          {% if p.get('evidence') %}
            <div style="background: #fffbeb; border-left: 3px solid #f59e0b; padding: 8px 12px; margin: 12px 0; border-radius: 4px;">
              <div class="small" style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Rationale:</div>
              <ul style="margin: 4px 0 0 16px; padding: 0;">
                {% for e in p['evidence'][:2] %}
                <li class="small" style="color: #78350f;">{{ e }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          
          <div class="small" style="margin-top:12px; padding: 8px; background: #fffbeb; border-radius: 6px;">
            <strong>Test Parameters:</strong> {{ (p.get('pilot_audience_fraction',0.2)*100)|int }}% of audience ‚Ä¢ 
            Budget: {{ fmt_money(p.get('pilot_budget_cap', 200)) }} ‚Ä¢ 
            Duration: 28 days ‚Ä¢ 
            Success: {{ p.get('decision_rule','CI excludes 0') }}
          </div>
          
          {% if p.get('action_id') %}
          <div class="cta-row" style="margin-top: 12px;">
            <span class="btn btn-track" onclick="alert('Start pilot tracking: {{ p.action_id }}'); return false;">
              üöÄ Start Pilot
            </span>
          </div>
          {% endif %}
        </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- Watchlist -->
    {% if outputs.get('watchlist') and outputs['watchlist'] %}
    <section class="section">
      <h2>Watchlist <span class="pill" style="background: #f3f4f6;">Monitoring</span></h2>
      {% for w in outputs['watchlist'] %}
        <div class="action-card watchlist-card">
          <div class="action-title">{{ w.get('title','') }}</div>
          <div class="small muted" style="margin-top:8px;">
            {% if w.get('reasons') %}
              {{ w['reasons'] | join(' ‚Ä¢ ') }}
            {% else %}
              Needs: {{ (w.get('failed', []) or ['more data']) | join(', ') }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
    {% endif %}

    <!-- Evidence Section -->
    <section class="section">
      <h2>Statistical Evidence</h2>
      <div style="background: #f9fafb; border-radius: 12px; padding: 20px;">
        <p class="muted" style="margin-bottom: 16px;">Why we believe this month's actions will drive results:</p>
        <ul style="margin-left: 20px;">
          {% if outputs.receipts and outputs.receipts|length > 0 %}
            {% for r in outputs.receipts %}
              <li style="margin: 8px 0; color: #374151;">{{ r }}</li>
            {% endfor %}
          {% else %}
            <li>Actions selected based on L28 performance deltas with statistical significance (p < 0.05)</li>
            <li>Expected impact calculated using your store's historical conversion rates and gross margin</li>
            <li>Confidence levels determined through Benjamini-Hochberg adjusted testing to minimize false positives</li>
          {% endif %}
        </ul>
        
        {% if outputs.performance_summary and outputs.performance_summary.n_completed > 0 %}
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <p class="small muted">
            <strong>Historical Accuracy:</strong> 
            Our predictions have been {{ outputs.performance_summary.aggregate_accuracy_pct }}% accurate on average across 
            {{ outputs.performance_summary.n_completed }} tracked actions.
          </p>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Attachments -->
    {% if outputs.get('segments_bundle') %}
    <section class="section">
      <h2>Attachments</h2>
      <div style="background: #f9fafb; border-radius: 8px; padding: 16px;">
        <strong>Segments Bundle:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px;">{{ outputs['segments_bundle'] }}</code>
        <div class="small muted" style="margin-top: 8px;">Ready for Klaviyo import - contains all customer segments for this month's actions</div>
      </div>
    </section>
    {% endif %}
  </div>

  <footer class="footer">
    <strong style="color: #6366f1;">Aura Intelligence</strong><br>
    Prescriptive Analytics for Beauty & Wellness Brands<br>
    <div style="margin-top: 8px; font-size: 12px;">
      Generated {{ aligned['anchor'].strftime('%B %d, %Y at %I:%M %p') if aligned.get('anchor') else 'today' }} ‚Ä¢ 
      Analysis window: {{ outputs.cfg.get('CHOSEN_WINDOW', 'L28') }} ‚Ä¢ 
      {% if outputs.validation_results %}
        Data Quality: {{ outputs.validation_results.data_quality_grade }} ‚Ä¢ 
      {% endif %}
      Confidence threshold: 90%
    </div>
  </footer>
</div>

<script>
// Action tracking functions
function markImplemented(actionId) {
  const modal = confirm(`Mark action ${actionId} as implemented?\n\nThis will start tracking its performance.`);
  if (modal) {
    alert('Action marked as implemented. Check back in 28 days to log results.');
  }
}

function trackResults(actionId) {
  const revenue = prompt('Enter actual revenue generated:');
  if (revenue) {
    alert(`Results tracked for ${actionId}: ${revenue}`);
  }
}

// Copy action ID to clipboard
function copyActionId(actionId) {
  navigator.clipboard.writeText(actionId).then(function() {
    alert('Action ID copied to clipboard');
  });
}

// Initialize tooltips for action IDs
document.addEventListener('DOMContentLoaded', function() {
  const actionIds = document.querySelectorAll('.action-id');
  actionIds.forEach(function(el) {
    el.style.cursor = 'pointer';
    el.addEventListener('click', function() {
      copyActionId(el.getAttribute('title'));
    });
  });
});
</script>

</body>
</html>
