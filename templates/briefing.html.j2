<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Narrative Briefing — {{ brand }}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif; margin: 24px; color: #111; }
    h1,h2,h3 { margin: 0 0 8px 0; }
    h1 { font-size: 24px; }
    h2 { font-size: 18px; margin-top: 20px; }
    h3 { font-size: 16px; margin-top: 12px; }
    .muted { color: #555; }
    .small { font-size: 12px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-left: 6px; background: #f2f2f2; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .kpi { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .row { display: grid; grid-template-columns: 1.2fr 1fr 0.9fr 1fr; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #eee; }
    .row.header { font-weight: 600; border-bottom: 1px solid #ddd; }
    .row:last-child { border-bottom: none; }
    .green { color: #0a7f2e; } .red { color: #b00020; } .gray { color: #777; }
    .tag { background: #eef2ff; color: #1e40af; border-radius: 6px; padding: 2px 6px; font-size: 12px; margin-left: 6px; }
    .section { margin-top: 28px; }
    ul { margin: 6px 0 0 18px; }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
    /* Charts: single row, auto-fit to N charts */
    .charts-one-line { display: grid; gap: 8px; align-items: stretch; }
    .chart-card { border:1px solid #eee; border-radius:10px; padding:6px; background:#fff; }
    img.chart { width: 100%; height: auto; max-height: 360px; object-fit: contain; border-radius:6px; display:block; }
    /* Actions: high-emphasis cards */
    .actions-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .action-checklist { list-style:none; padding-left:0; margin:8px 0 16px 0; }
    .action-checklist li { margin: 4px 0; }
    .action-card { border:1px solid #e5e7eb; border-left:6px solid #2563eb; background:#f8fafc; border-radius:12px; padding:14px; margin:12px 0; }
    .action-title { font-size:16px; font-weight:600; }
    .num { width:26px; height:26px; border-radius:50%; background:#2563eb; color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; }
    .badges { margin-left:auto; display:flex; gap:6px; flex-wrap:wrap; }
    .badge { font-size:12px; border-radius:999px; padding:2px 8px; background:#eef2ff; color:#1e40af; }
    .impact { background:#ecfdf5; color:#065f46; }
    .effort { background:#fff7ed; color:#9a3412; }
    .cta-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn { display:inline-block; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; text-decoration:none; color:#111; background:#fff; }
    .btn:hover { background:#f3f4f6; }
    .steps ul { margin:6px 0 0 18px; }
    .prev { color:#888; }
  </style>
</head>
<body>

{% macro fmt_money(x, decimals=0) -%}
  {{ ('$%.' ~ decimals ~ 'f') % x if x is not none else '—' }}
{%- endmacro %}

{% macro fmt_pct(x, digits=1) -%}
  {{ ('%.' ~ digits ~ 'f%%') % (x*100) if x is not none else '—' }}
{%- endmacro %}

{% macro fmt_delta_pct(x, digits=1) -%}
  {{ ('%+' ~ digits ~ '.1f%%') % (x*100) if x is not none else '—' }}
{%- endmacro %}

{% macro arrow(delta, good_when_up=True, significant=True) -%}
  {%- set dir = 'up' if (delta is not none and delta >= 0) else 'down' -%}
  {%- set good = (delta is not none) and ((delta >= 0 and good_when_up) or (delta < 0 and not good_when_up)) -%}
  {%- set color = 'green' if (significant and good) else ('red' if (significant and not good) else 'gray') -%}
  <span class="{{ color }}">{{ '▲' if dir == 'up' else '▼' }}</span>
{%- endmacro %}

{% macro prev_val(curr, delta) -%}
  {%- if curr is not none and delta is not none and (1 + delta) != 0 -%}
    {{ curr / (1 + delta) }}
  {%- else -%}
    {{ None }}
  {%- endif -%}
{%- endmacro %}

{% macro kpi_block(label) -%}
  <div class="kpi">
    <div class="row header">
      <div>Metric</div><div>Value</div><div>Δ vs prior</div><div>Notes</div>
    </div>

    {# Net Sales #}
    {% set curr = aligned[label]['net_sales'] %}
    {% set dlt = aligned[label]['delta']['net_sales'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div>Net Sales</div>
      <div>{{ fmt_money(curr) }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev) }})</span>
      </div>
      <div class="small muted">vs previous {{ aligned[label]['window_days'] }} days</div>
    </div>

    {# Orders #}
    {% set curr = aligned[label]['orders'] %}
    {% set dlt = aligned[label]['delta']['orders'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div>Orders</div>
      <div>{{ curr if curr is not none else '—' }}</div>
      <div>
        {{ arrow(dlt, True, True) }} {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ prev|int if prev is not none else '—' }})</span>
      </div>
      <div class="small muted">vs previous {{ aligned[label]['window_days'] }} days</div>
    </div>

    {# AOV #}
    {% set curr = aligned[label]['aov'] %}
    {% set dlt = aligned[label]['delta']['aov'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div>AOV</div>
      <div>{{ fmt_money(curr, 2) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['aov']) }}
        {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_money(prev, 2) }})</span>
      </div>
      <div class="small muted">
        {% if aligned[label]['p']['aov'] is not none %}p={{ '%.3f' % aligned[label]['p']['aov'] }}{% else %}—{% endif %}
      </div>
    </div>

    {# Discount Rate #}
    {% set curr = aligned[label]['discount_rate'] %}
    {% set dlt = aligned[label]['delta']['discount_rate'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div>Discount Rate</div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, False, aligned[label]['sig']['discount_rate']) }}
        {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% if aligned[label]['p']['discount_rate'] is not none %}p={{ '%.3f' % aligned[label]['p']['discount_rate'] }}{% else %}—{% endif %}
      </div>
    </div>

    {# Repeat Share #}
    {% set curr = aligned[label]['repeat_share'] %}
    {% set dlt = aligned[label]['delta']['repeat_share'] %}
    {% set prev = (curr / (1 + dlt)) if (curr is not none and dlt is not none and (1 + dlt) != 0) else none %}
    <div class="row">
      <div>Repeat Share</div>
      <div>{{ fmt_pct(curr, 1) }}</div>
      <div>
        {{ arrow(dlt, True, aligned[label]['sig']['repeat_share']) }}
        {{ fmt_delta_pct(dlt) }}
        <span class="small prev">(prev {{ fmt_pct(prev, 1) }})</span>
      </div>
      <div class="small muted">
        {% if aligned[label]['p']['repeat_share'] is not none %}p={{ '%.3f' % aligned[label]['p']['repeat_share'] }}{% else %}—{% endif %}
      </div>
    </div>
  </div>
{%- endmacro %}

<header>
  <h1>Weekly Revenue Briefing — {{ brand }}</h1>
  <div class="muted">Week of {{ aligned['anchor'].strftime('%Y-%m-%d') if aligned.get('anchor') else '' }}</div>
</header>

<section class="section">
  <h2>KPI Snapshot</h2>
  <div class="grid">
    <div>
      <h3>L7</h3>
      {{ kpi_block('L7') }}
    </div>
    <div>
      <h3>L28</h3>
      {{ kpi_block('L28') }}
    </div>
  </div>
</section>

{% if outputs.get('charts') and outputs['charts'] %}
<section class="section">
  <h2>Mini Charts</h2>
  {# Force single line by setting columns == number of charts #}
  <div class="charts-one-line" style="grid-template-columns: repeat({{ outputs['charts']|length }}, minmax(120px, 1fr));">
    {% for c in outputs['charts'] %}
      <div class="chart-card"><img class="chart" src="{{ c }}" alt="chart {{ loop.index }}" /></div>
    {% endfor %}
  </div>
</section>
{% endif %}

<section class="section">
  <h2>Your Top Actions <span class="pill">Do these this week</span></h2>

  {% if outputs.get('actions') and outputs['actions'] %}
    <!-- Quick checklist summary -->
    <ul class="action-checklist">
      {% for a in outputs['actions'] %}
        <li>☐ <strong>{{ a.get('title','') }}</strong> — {{ a.get('do_this','') }}</li>
        {% if a.get('offer') %}
          <div class="small muted">
             Offer: {{ a['offer'].get('type') }}{% if a['offer'].get('value') %} ({{ a['offer']['value'] }}%){% endif %}
          </div>
        {% elif a.get('variant_id') %}
          <div class="small muted">Variant: {{ a['variant_id'] }}</div>
        {% endif %}
      {% endfor %}
    </ul>

    {% for a in outputs['actions'] %}
      <div class="action-card">
        <div class="actions-header">
          <div class="num">{{ loop.index }}</div>
          <div class="action-title">{{ a.get('title','') }}</div>
          <div class="badges">
            {% if a.get('expected_$') %}<span class="badge impact">Est. {{ fmt_money(a.get('expected_$')) }}</span>{% endif %}
            {% if a.get('effort') is not none %}<span class="badge effort">Effort: {{ a.get('effort') }}</span>{% endif %}
            {% if a.get('confidence_label') %}<span class="badge">{{ a.get('confidence_label') }}</span>{% endif %}
          </div>
        </div>
        <div class="muted">{{ a.get('do_this','') }}</div>
        {% if a.get('how_to_launch') %}
          <div class="steps">
            <div class="small" style="margin-top:6px;"><strong>Steps:</strong></div>
            <ul>
              {% for step in a['how_to_launch'][:5] %}<li>{{ step }}</li>{% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="cta-row">
          {% if a.get('attachment') %}<span class="btn">⬇︎ Download: {{ a.get('attachment') }}</span>{% endif %}
          {% if a.get('targeting') %}<span class="btn">🎯 Targeting</span>{% endif %}
          {% if a.get('offer') %}<span class="btn">🏷 Offer</span>{% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted">No actions passed all gates. See Pilot below.</div>
  {% endif %}
</section>

{% if outputs.get('pilot_actions') and outputs['pilot_actions'] %}
<section class="section">
  <h2>Pilot (if no top actions)</h2>
  {% for p in outputs['pilot_actions'] %}
    <div class="action-card" style="border-left-color:#0ea5e9;">
      <div class="actions-header">
        <div class="num">P</div>
        <div class="action-title">{{ p.get('title','') }}</div>
        <div class="badges">
          <span class="badge">Pilot</span>
          {% if p.get('expected_$') %}<span class="badge impact">Est. {{ fmt_money(p.get('expected_$')) }}</span>{% endif %}
        </div>
      </div>
      <div class="muted">{{ p.get('do_this','') }}</div>
      {% if p.get('offer') %}
        <div class="small muted">
          Offer: {{ p['offer'].get('type') }}{% if p['offer'].get('value') %} ({{ p['offer']['value'] }}%){% endif %}
        </div>
      {% elif p.get('variant_id') %}
        <div class="small muted">Variant: {{ p['variant_id'] }}</div>
      {% endif %}
      <div class="small" style="margin-top:6px;">
        Audience: ~{{ (p.get('pilot_audience_fraction',0.2)*100)|int }}% &nbsp;•&nbsp;
        Budget cap: {{ fmt_money(p.get('pilot_budget_cap', 0)) }} &nbsp;•&nbsp;
        Decision rule: {{ p.get('decision_rule','') }}
      </div>
    </div>
  {% endfor %}
</section>
{% endif %}

{% if outputs.get('watchlist') is not none %}
<section class="section">
  <h2>Watchlist (Directional — needs more data or $)</h2>
  {% if outputs['watchlist'] %}
    {% for w in outputs['watchlist'] %}
      <div class="action-card" style="border-left-color:#9ca3af;background:#fcfcfd;">
        <div class="action-title">{{ w.get('title','') }} <span class="pill">Watch</span></div>
        <div class="small muted" style="margin-top:4px;">
          {% if w.get('reasons') %}
            {{ w['reasons'] | join('; ') }}
          {% else %}
            Fails: {{ (w.get('failed', []) or []) | join(', ') }}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted">No watchlist items this week.</div>
  {% endif %}
</section>
{% endif %}

{% if outputs.get('backlog') is not none %}
<section class="section">
  <h2>Backlog (Passed gates — deferred)</h2>
  {% if outputs['backlog'] %}
    <ul>
    {% for b in outputs['backlog'] %}
      <li><strong>{{ b.get('title','') }}</strong> — <span class="muted">{{ b.get('reason','ranked below top actions') }}</span></li>
    {% endfor %}
    </ul>
  {% else %}
    <div class="muted">No backlog items.</div>
  {% endif %}
</section>
{% endif %}

<section class="section">
  <h2>Receipts</h2>
  <p class="muted">Why we believe this week’s actions will work — based on your recent deltas and store baselines.</p>
  <ul class="receipts">
   {% if outputs.receipts and outputs.receipts|length > 0 %}
     {% for r in outputs.receipts %}
       <li>{{ r }}</li>
     {% endfor %}
   {% else %}
     <li>We selected these actions based on L28 deltas in AOV, orders, discount share, and repeat mix; no single metric dominated the decision.</li>
   {% endif %}
  </ul>

</section>

{% if outputs.get('segments_bundle') %}
<section class="section">
  <h2>Attachments</h2>
  <div class="small muted">Segments bundle: <code>{{ outputs['segments_bundle'] }}</code> (upload to Klaviyo as lists/segments)</div>
</section>
{% endif %}

</body>
</html>
